---
# This playbook deploys the entire web hosting stack

- name: Configure and deploy the control tier
  hosts: control
  become: true
  roles:
    - nfs_client

- name: Configure and deploy the master database tier
  hosts: database_master
  become: true
  roles:
    - ubuntu20  
    - mariadb_master
    - zabbix_agent        

- name: Configure and deploy the slave database tier
  hosts: database_slave
  become: true
  roles:
    - ubuntu20  
    - mariadb_slave      
    - zabbix_agent   

- name: Configure and deploy the storage tier
  hosts: storage
  become: true
  roles:
    - ubuntu20  
    - rclone
    - filestore    
    - zabbix_agent   

- name: Configure and deploy the web tier
  hosts: webservers
  become: true
  roles:
    - ubuntu20  
    - nfs_client
    - nginx 
    - zabbix_agent

- name: Configure and deploy the wp_admin tier
  hosts: wp_admin
  become: true
  roles:
    - ubuntu20      
    - nfs_client
    - wp_admin
    - zabbix_agent       

- name: Configure and deploy the balance tier
  hosts: loadbalancers
  become: true
  vars:
    webnodes: "{{ groups['webservers'] }}"
    wpanodes: "{{ groups['wp_admin'] }}"
  roles:
    - ubuntu20  
    - haproxy
    - zabbix_agent       
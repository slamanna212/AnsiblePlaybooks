#################################################
# DO Community Playbooks: Initial Server Setup
#################################################
---
    - hosts: all
      become: true
      vars_files:
        - /group_vars/default.yml
    
      tasks:
        - name: Install Prerequisites
          apt: name=aptitude update_cache=yes state=latest force_apt_get=yes
    
    # Install Packages
        - name: Update apt
          apt: update_cache=yes
    
        - name: Install required system packages
          apt: name={{ sys_packages }} state=latest

    # Sudo Group Setup
        - name: Make sure we have a 'bene' group
          group:
            name: bene
            state: present
    
        - name: Allow 'bene' group to have passwordless sudo
          lineinfile:
            path: /etc/sudoers
            state: present
            regexp: '^%bene'
            line: '%bene ALL=(ALL) NOPASSWD: ALL'
            validate: '/usr/sbin/visudo -cf %s'
    
    # User + Key Setup
        - name: Create a new regular user with sudo privileges
          user:
            name: "{{ create_user }}"
            state: present
            groups: bene
            append: true
            create_home: true
            shell: /bin/bash
    
        - name: Set authorized key for remote user
          authorized_key:
            user: "{{ create_user }}"
            state: present
            key: "{{ copy_local_key }}"
    
        - name: Disable password authentication for root
          lineinfile:
            path: /etc/ssh/sshd_config
            state: present
            regexp: '^#?PermitRootLogin'
            line: 'PermitRootLogin prohibit-password'

    # MOTD Access Message
        - name: Upload custom MOTD access warning
          copy:
           src: /group_vars/Ubuntu18.issue.net
           dest: /etc/issue.net
           remote_src: no

        - name: Disable default banner message from MOTD
          become: yes
          become_user: root
          lineinfile:
           path: /etc/pam.d/sshd
           regexp: '{{item.From}}'
           line: '{{item.To}}'
           state: present  
          with_items:
              - { From: 'session    optional     pam_motd.so  motd=/run/motd.dynamic', To: '# session    optional     pam_motd.so  motd=/run/motd.dynamic' }
              - { From: 'session    optional     pam_motd.so noupdate', To: '# session    optional     pam_motd.so noupdate' }

        - name: Enable custom MOTD message
          become: yes
          become_user: root
          ansible.builtin.lineinfile:
            path: /etc/ssh/sshd_config
            line: Banner /etc/issue.net
            create: yes
         
    # Fail2Ban Config
        - name: Upload Fail2Ban config
          copy:
           src: /group_vars/Ubuntu18.jail.local
           dest: /etc/fail2ban/jail.local
           remote_src: no        
        

    # Cleanup        
        - name: Restart Fail2Ban and make sure it starts at boot
          ansible.builtin.systemd: 
            name: fail2ban
            enabled: yes
            state: restarted

        - name: Restart SSH service to ensure changes are loaded
          ansible.builtin.service:
            name: sshd
            state: restarted



#################################################
# Loadbalancers config
#################################################
---
    - hosts: loadbalancers
      become: true
      vars_files:
        - group_vars/loadbalancers.yml
      vars:
        backends: "{{ groups['webservers'] }}"

    # This shouldnt be needed but if its not here the playbook doesnt run, i have no idea
      tasks:
        - name: Install Prerequisites
          apt: name=aptitude update_cache=yes state=latest force_apt_get=yes
    
    # Install Packages
        - name: Update package mirrors and existing packages
          apt: update_cache=yes upgrade=yes
    
        - name: Install required system packages
          apt: name={{ sys_packages }} state=latest



    # Netdata
        - name: Grant Netdata user access to haproxy group
          user:
            name: netdata
            state: present
            groups: netdata,haproxy
            append: true
      
          
    # Add cloudflare origin cert
        - name: Add Cloudflare origin certificate to server(s)
          copy:
           src: files/Loadbalancers/beneorigin.pem
           dest: /etc/ssl/private/beneorigin.pem
           remote_src: no

        - name: Set ownership for certificate
          ansible.builtin.file:
            path: /etc/ssl/private/beneorigin.pem
            owner: haproxy
            group: haproxy

    # Upload templated haproxy config

        - name: Update HAProxy config
          template: src=templates/haproxy.cfg 
                      dest=/etc/haproxy/haproxy.cfg 
                      backup=no                

    # Cleanup        
        - name: Restart HAProxy and make sure it starts at boot
          ansible.builtin.systemd: 
            name: haproxy
            enabled: yes
            state: restarted
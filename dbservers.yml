#################################################
# Database config
#################################################
---
    - hosts: databases
      become: true
      vars_files:
        - group_vars/databases.yml

    # This shouldnt be needed but if its not here the playbook doesnt run, i have no idea
      tasks:
        - name: Install Prerequisites
          apt: name=aptitude update_cache=yes state=latest force_apt_get=yes
    
    # Install Packages
        - name: Update package mirrors and existing packages
          apt: update_cache=yes upgrade=yes
    
        - name: Install required system packages
          apt: name={{ sys_packages }} state=latest


    - hosts: BeneNYCDB01v          
      tasks:
        - name: Allow incoming connections on the master node
          become: yes
          become_user: root
          lineinfile:
           path: /etc/mysql/mariadb.conf.d/50-server.cnf
           regexp: 'bind-address            = 127.0.0.1'
           line: 'bind-address            = 0.0.0.0'
           state: present  

        - name: Update master node config
          become: yes
          become_user: root
          blockinfile:
            path: /etc/mysql/mariadb.conf.d/50-server.cnf
            block: |
              server-id = 1
              log_bin = /var/log/mysql/mysql-bin.log
              log_bin_index =/var/log/mysql/mysql-bin.log.index
              relay_log = /var/log/mysql/mysql-relay-bin' 
              relay_log_index = /var/log/mysql/mysql-relay-bin.index


        - name: Restart MariaDB to load changes
          ansible.builtin.systemd: 
            state: restarted
            name: mariadb 
                      


    - hosts: BeneNYCDB02v          
      tasks:
        - name: Allow incoming connections on the slave node
          become: yes
          become_user: root
          lineinfile:
           path: /etc/mysql/mariadb.conf.d/50-server.cnf
           regexp: 'bind-address            = 127.0.0.1'
           line: 'bind-address            = 0.0.0.0'
           state: present  

        - name: Update slave node config
          become: yes
          become_user: root        
          blockinfile:
            path: /etc/mysql/mariadb.conf.d/50-server.cnf
            block: |
              server-id = 2
              log_bin = /var/log/mysql/mysql-bin.log
              log_bin_index =/var/log/mysql/mysql-bin.log.index
              relay_log = /var/log/mysql/mysql-relay-bin' 
              relay_log_index = /var/log/mysql/mysql-relay-bin.index

        - name: Restart MariaDB to load changes
          ansible.builtin.systemd: 
            name: mariadb 
            state: restarted                               
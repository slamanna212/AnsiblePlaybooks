---
- hosts: localhost
  tasks: 
# Test Initial Provision using specific key
        - name: Genrate Random Number
          set_fact:
            num: "{{start=11, 99 | random }}"

#        - name: Create a new Droplet
#          community.digitalocean.digital_ocean_droplet:
#            state: present
#            oauth_token: "{{ lookup('ansible.builtin.env', 'DO_API_TOKEN') }}"
#            name: Bene-NYC-Web{{ num }}v
#            size: s-1vcpu-1gb-amd
#            region: nyc3
#            tags: bene
#            image: ubuntu-20-04-x64
#            project: Bene IT Websites
#            wait_timeout: 500
#            ssh_keys: [ a6:84:ee:f8:05:03:7d:24:09:d2:68:84:8e:d3:72:49 ]
#          register: droplet_create_temp

# Droplet Creation commnad does not pass IP addresses, using seperate task to grab IP address

        - name: Get Private IP address of new Droplet
          community.digitalocean.digital_ocean_droplet_info:
            oauth_token: "{{ lookup('ansible.builtin.env', 'DO_API_TOKEN') }}"
            id: "283643502"
          register: droplet_temp


        - name: Show Droplet info
          ansible.builtin.debug:
            msg:
            - "Name is {{ droplet_temp.data[0].name }}"
            - "Private IP is {{  (droplet_temp.data[0].networks.v4[1].ip_address) }}"

        - name: Add the new droplet to the inventory
          ansible.builtin.lineinfile:
            path=/etc/ansible/hosts
            insertafter="[provisioning]"
            line="{{ droplet_temp.data[0].name }} ansible_host={{  (droplet_temp.data[0].networks.v4[1].ip_address) }}"
#Refresh inventory to pickup new host

- name: Refresh inventoryto pickup new host
  meta: refresh_inventory

# Bring new host up to baseline state

- name: Run Baseline 
  hosts: provisioning
  become: true
  become_user: root
  vars:
    ansible_ssh_private_key_file: ~/.ssh/doinit
    ansible_ssh_user: root
  roles:
    - ubuntu20    